<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Applyce</title>
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  {% include 'components/navbar.html' %}

  <main class="section">
    <div class="container">
      <div class="section-header">
        <div>
          <p class="section-subtitle">Dashboard</p>
          <h1 class="section-title">Welcome back, {{ user.username if user else 'Professional' }}!</h1>
          <p class="helper-text">Track your resume performance, AI insights, and career progress in one place.</p>
        </div>
        <a class="btn btn-primary" href="/upload"><i class="fas fa-cloud-upload-alt"></i> Upload New Resume</a>
      </div>

      <div class="stats-grid" style="margin-top:2.5rem;">
        <div class="glass card stats-card">
          <p class="helper-text">Resume Score</p>
          <h3>{{ latest_score or 0 }}%</h3>
          <span class="badge-success">{{ improvement or 0 }}% ▲</span>
        </div>
        <div class="glass card stats-card">
          <p class="helper-text">ATS Score</p>
          <h3>{{ latest_ats_score or 0 }}%</h3>
          <span class="badge-warning">{{ ats_improvement or 0 }}% ▲</span>
        </div>
        <div class="glass card stats-card">
          <p class="helper-text">Career Match</p>
          <h3>{{ top_career or 'AI Product Strategist' }}</h3>
          <span class="badge">{{ career_confidence or 90 }}% confidence</span>
        </div>
        <div class="glass card stats-card">
          <p class="helper-text">Best Score</p>
          <h3>{{ best_score or 0 }}%</h3>
          <span class="badge-purple">Top result</span>
        </div>
      </div>

      <div class="section" style="padding-top:2.5rem;">
        <div class="glass card">
          <div class="section-header" style="margin-bottom:1.5rem;">
            <h2>Score Progress</h2>
            <span class="badge">Resume vs ATS</span>
          </div>
          <canvas id="scoreChart" height="120"></canvas>
        </div>
      </div>

      <div class="section" style="padding-top:2.5rem;">
        <div class="glass card">
          <div class="section-header" style="margin-bottom:1.5rem;">
            <h2>Resume History</h2>
            <span class="badge">{{ total_resumes or 0 }} uploads</span>
          </div>
          <div style="overflow:auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Filename</th>
                  <th>Resume Score</th>
                  <th>ATS Score</th>
                  <th>Career Match</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for item in history %}
                <tr>
                  <td>{{ item.upload_date.strftime('%Y-%m-%d') }}</td>
                  <td>{{ item.filename }}</td>
                  <td>{{ item.overall_score }}%</td>
                  <td>{{ item.ats_score }}%</td>
                  <td>{{ item.predicted_career or top_career }}</td>
                  <td>
                    <form method="POST" action="/dashboard/delete/{{ item.id }}">
                      <button class="btn btn-outline" type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="6" class="helper-text">No uploads yet. Upload a resume to start tracking.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="section" style="padding-top:2.5rem;">
        <div class="grid" style="display:grid; gap:2rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
          <div class="glass card">
            <h2>Career Roadmap Progress</h2>
            <p class="helper-text">Track your journey across each phase.</p>
            {% if roadmap_data %}
              {% for phase in roadmap_data %}
                <div style="margin-top:1.5rem;">
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>{{ phase.phase }}</strong>
                    <span class="badge">{{ phase.progress or 0 }}%</span>
                  </div>
                  <div class="progress" style="margin-top:0.5rem;">
                    <div class="progress-bar" style="width: {{ phase.progress or 0 }}%;"></div>
                  </div>
                  <p class="helper-text" style="margin-top:0.5rem;">{{ phase.skills | join(', ') if phase.skills else 'Skill milestones tailored to your goals.' }}</p>
                </div>
              {% endfor %}
            {% else %}
              <p class="helper-text" style="margin-top:1.5rem;">Upload a resume to generate your roadmap progress.</p>
            {% endif %}
          </div>
          <div class="glass card">
            <h2>Skills Analysis</h2>
            <p class="helper-text">Your current strengths and focus areas.</p>
            <h4 style="margin-top:1.5rem;">Owned Skills</h4>
            <div class="chip-list">
              {% for skill in all_skills[:10] %}
                <span class="tag tag-green">{{ skill }}</span>
              {% else %}
                <span class="tag tag-green">Strategic thinking</span>
                <span class="tag tag-green">Communication</span>
                <span class="tag tag-green">Project management</span>
              {% endfor %}
            </div>
            <h4 style="margin-top:1.5rem;">Skills to Learn</h4>
            <div class="chip-list">
              {% for skill in missing_skills[:8] %}
                <span class="tag tag-orange">{{ skill }}</span>
              {% else %}
                <span class="tag tag-orange">AI product analytics</span>
                <span class="tag tag-orange">Data storytelling</span>
                <span class="tag tag-orange">Leadership coaching</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="section" style="padding-top:2.5rem;">
        <div class="glass card">
          <div class="section-header" style="margin-bottom:1.5rem;">
            <h2>Recommendations</h2>
            <span class="badge">Next best actions</span>
          </div>
          <div class="icon-grid">
            <div class="glass-soft card">
              <h4><i class="fas fa-magic"></i> Strengthen ATS Keywords</h4>
              <p class="helper-text">Add 5 missing keywords to boost ATS score by 8-12%.</p>
            </div>
            <div class="glass-soft card">
              <h4><i class="fas fa-road"></i> Complete Roadmap Phase 1</h4>
              <p class="helper-text">Finish 2 foundational courses to unlock intermediate milestones.</p>
            </div>
            <div class="glass-soft card">
              <h4><i class="fas fa-briefcase"></i> Apply to 3 top matches</h4>
              <p class="helper-text">Apply to roles with 90%+ match scores in the Job Search tab.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  {% include 'components/footer.html' %}

  <script>
    const historyData = {{ score_history|tojson if score_history else '[]' }};
    const labels = historyData.map(item => item.date || '');
    const resumeScores = historyData.map(item => item.score || 0);
    const atsScores = historyData.map(item => item.ats_score || item.score || 0);

    const ctx = document.getElementById('scoreChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Resume Score',
              data: resumeScores,
              borderColor: '#00c2ff',
              backgroundColor: 'rgba(0, 194, 255, 0.15)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'ATS Score',
              data: atsScores,
              borderColor: '#00ff88',
              backgroundColor: 'rgba(0, 255, 136, 0.12)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          plugins: {
            legend: { labels: { color: '#e0e0e0' } }
          },
          scales: {
            x: { ticks: { color: '#888' }, grid: { color: 'rgba(148,163,184,0.1)' } },
            y: { ticks: { color: '#888' }, grid: { color: 'rgba(148,163,184,0.1)' } }
          }
        }
      });
    }
  </script>
</body>
</html>
